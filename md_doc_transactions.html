<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DLite: Transactions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DLite
   &#160;<span id="projectnumber">0.3.15</span>
   </div>
   <div id="projectbrief">A lightweight data-centric framework for semantic interoperability</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Transactions </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Transactions is a concept that comes from SOFT, which allows to easy manage arbitrary long series of immutable (frozen) instances, while ensuring provenance. Conceptually, it shares many similarities with <a href="https://git-scm.com">git</a>.</p>
<p>A basic usage for transactions is to take snapshots of the current state of your system. This is shown in Figure 1, where we assume that the instance <code>A</code> (which, e.g., could be a collection) describes the state of your system.</p>
<p>We call an instance a <em>transaction</em> after we have taken a snapshot of it, i.e. when it contains a reference to an immutable previous ("parent") instance.</p>
<p><img src="figs/transactions.png" alt="transactions" class="inline"/></p>
<p><b>Figure 1</b>: <em>Creating a transaction by taking snapshots. (a) initial state of your system described by instance <code>A</code>. (b) creating a transaction by taking a snapshot of <code>A</code> at time <code>t1</code>. The snapshot, <code>A1</code>, stores an immutable (frozen) copy of <code>A</code> from the exact moment <code>t1</code> the snapshot was taken. (c) After another snapshot was taken at a later time <code>t2</code>. Blue circles represent immutable instances, red circles represent mutable instances, while arrows relate an instance to its (frozen) parent instance.</em></p>
<p>It is straight forward to create such snapshots using the Python and C APIs. In Python, the steps in Figure 1 can be produced by the following code:</p>
<div class="fragment"><div class="line">A = dlite.get_instance(&quot;A&quot;)  # Initial state (Fig. 1a)</div>
<div class="line">A.snapshot()                 # Make snapshot at time=t1 (Fig. 1b)</div>
<div class="line"># A is evolved...</div>
<div class="line">A.snapshot()                 # Make snapshot at time=t2 (Fig. 1c)</div>
</div><!-- fragment --><p>The corresponding code in C would be:</p>
<div class="fragment"><div class="line"><a class="code" href="struct__DLiteInstance.html">DLiteInstance</a> *A = <a class="code" href="dlite-entity_8h.html#acd671a3f990fde29c7853f08110c989c">dlite_instance_get</a>(<span class="stringliteral">&quot;A&quot;</span>);  <span class="comment">// Initial state (Fig. 1a)</span></div>
<div class="line"><a class="code" href="dlite-entity_8h.html#a99cf3b96dc5c6d80f72f6e8950cbd9d9">dlite_instance_snapshot</a>(A);                  <span class="comment">// Make snapshot at time=t1 (Fig. 1b)</span></div>
<div class="line"><span class="comment">// A is evolved...</span></div>
<div class="line"><a class="code" href="dlite-entity_8h.html#a99cf3b96dc5c6d80f72f6e8950cbd9d9">dlite_instance_snapshot</a>(A);                  <span class="comment">// Make snapshot at time=t2 (Fig. 1c)</span></div>
</div><!-- fragment --><p>The snapshots can be accessed using <code><a class="el" href="dlite-entity_8h.html#ab8e8ca7e95e921821851ef5779a5e5fc">dlite_instance_get_snapshot()</a></code>. For instance, accessing snapshot <code>A2</code> and creating a new branch from it can be achieved by the following four lines of Python code:</p>
<div class="fragment"><div class="line">A2 = A.get_snapshot()  # Access the most recent snapshot of A</div>
<div class="line">B = A2.copy()          # Create a mutable copy of A2</div>
<div class="line">B.set_parent(A2)       # Make B a transaction with A2 as parent. Shown in Fig. 2a.</div>
<div class="line">B.shapshot()           # Make a snapshop of B. Shown in Fig. 2b.</div>
</div><!-- fragment --><p>The corresponding C code is:</p>
<div class="fragment"><div class="line"><span class="comment">// Access the most recent snapshot of instance A.</span></div>
<div class="line"><span class="comment">// Note that A2 is a borrowed reference to the snapshot and should not be</span></div>
<div class="line"><span class="comment">// dereferenced with dlite_instance_decref().</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="struct__DLiteInstance.html">DLiteInstance</a> *A2 = <a class="code" href="dlite-entity_8h.html#ab8e8ca7e95e921821851ef5779a5e5fc">dlite_instance_get_snapshot</a>(A, 1);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a mutable copy of A2.</span></div>
<div class="line"><span class="comment">// Note that B is a new reference.  You should call dlite_instance_decref() when you</span></div>
<div class="line"><span class="comment">// are done with it.</span></div>
<div class="line"><a class="code" href="struct__DLiteInstance.html">DLiteInstance</a> *B = <a class="code" href="dlite-entity_8h.html#a7508e48de21dbd713b6400f0585f59b2">dlite_instance_copy</a>(A2);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Make B a transaction with A2 as parent. Shown in Fig. 2a.</span></div>
<div class="line"><a class="code" href="dlite-entity_8h.html#a415dffa953d659564c385e2869240826">dlite_instance_set_parent</a>(B, A2);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Make a snapshop of B. Shown in Fig. 2b.</span></div>
<div class="line"><a class="code" href="dlite-entity_8h.html#a99cf3b96dc5c6d80f72f6e8950cbd9d9">dlite_instance_snapshot</a>(B);</div>
</div><!-- fragment --><p>The result of these commands are shown in Figure 2.</p>
<p><img src="figs/transactions-branch.png" alt="transactions-branch" class="inline"/></p>
<p><b>Figure 2</b>: *Creating a new branch, from a snapshot of a transaction. (a) Create a copy (<code>B</code>) of latest snapshot of transaction <code>A</code>. (b) Take a snapshot of <code>B</code>.*</p>
<h2>Transaction parent and immutability</h2>
<p>All transactions start as a root instance with no parent instance. All other instances in a transaction has exactly <b>one</b> parent instance. All instances in a transaction that serve as a parent are immutable (that is, all instances except the leaves (the latest)). Non-root transaction instances store a <a href="https://en.wikipedia.org/wiki/SHA-3">SHA-3</a> hash of their parent together with the parent UUID. This makes it possible to ensure that any of the ancestors of a transaction have not been changed - providing provenance.</p>
<p>A transaction can be verified with the <code>verify_transaction()</code> method in Python and <code><a class="el" href="dlite-entity_8h.html#ad8387140531a0e137de9d43f4014407c">dlite_instance_verify_transaction()</a></code> in C.</p>
<h2>Memory management</h2>
<p>The number of snapshots can potentially be very large, hence it is important to be able to store them to disk in order to save memory. To support this, DLite implements the <code>pull_snapshot()</code> and <code>push_snapshot()</code> methods (<code><a class="el" href="dlite-entity_8h.html#a98482c62135e52010de2c8d87adc5720">dlite_instance_pull_snapshot()</a></code> and <code><a class="el" href="dlite-entity_8h.html#ae3ffc32afec9d82a59b237bfffbffffb">dlite_instance_push_snapshot()</a></code> in C).</p>
<p>Calling <code>inst.push_snapshot(storage, n)</code> will push all ancestors of snapshot <code>n</code> of instance <code>inst</code> from memory to storage <code>storage</code>, where <code>n=0</code> corresponds to <code>inst</code>, <code>n=1</code> to the parent of <code>inst</code>, etc... Hence, this will release memory.</p>
<p>Calling <code>inst.pull_snapshot(storage, n)</code> will pull snapshot <code>n</code> of instance <code>inst</code> as well as all its descendants from storage <code>storage</code> to memory. Hence, this is similar to <code>inst.get_snapshot(n)</code>, except that an explicit storage is used.</p>
<p>Note that not all storages can be used with these functions, since whether an instance is a transactions or not, is not described by its metadata and hence requires special support by the storage plugin. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="adlite-entity_8h_html_a99cf3b96dc5c6d80f72f6e8950cbd9d9"><div class="ttname"><a href="dlite-entity_8h.html#a99cf3b96dc5c6d80f72f6e8950cbd9d9">dlite_instance_snapshot</a></div><div class="ttdeci">int dlite_instance_snapshot(DLiteInstance *inst)</div><div class="ttdef"><b>Definition:</b> dlite-entity.c:2125</div></div>
<div class="ttc" id="adlite-entity_8h_html_a415dffa953d659564c385e2869240826"><div class="ttname"><a href="dlite-entity_8h.html#a415dffa953d659564c385e2869240826">dlite_instance_set_parent</a></div><div class="ttdeci">int dlite_instance_set_parent(DLiteInstance *inst, const DLiteInstance *parent)</div><div class="ttdef"><b>Definition:</b> dlite-entity.c:2288</div></div>
<div class="ttc" id="adlite-entity_8h_html_a7508e48de21dbd713b6400f0585f59b2"><div class="ttname"><a href="dlite-entity_8h.html#a7508e48de21dbd713b6400f0585f59b2">dlite_instance_copy</a></div><div class="ttdeci">DLiteInstance * dlite_instance_copy(const DLiteInstance *inst, const char *newid)</div><div class="ttdef"><b>Definition:</b> dlite-entity.c:1814</div></div>
<div class="ttc" id="adlite-entity_8h_html_acd671a3f990fde29c7853f08110c989c"><div class="ttname"><a href="dlite-entity_8h.html#acd671a3f990fde29c7853f08110c989c">dlite_instance_get</a></div><div class="ttdeci">DLiteInstance * dlite_instance_get(const char *id)</div><div class="ttdef"><b>Definition:</b> dlite-entity.c:670</div></div>
<div class="ttc" id="adlite-entity_8h_html_ab8e8ca7e95e921821851ef5779a5e5fc"><div class="ttname"><a href="dlite-entity_8h.html#ab8e8ca7e95e921821851ef5779a5e5fc">dlite_instance_get_snapshot</a></div><div class="ttdeci">const DLiteInstance * dlite_instance_get_snapshot(const DLiteInstance *inst, int n)</div><div class="ttdef"><b>Definition:</b> dlite-entity.c:2169</div></div>
<div class="ttc" id="astruct__DLiteInstance_html"><div class="ttname"><a href="struct__DLiteInstance.html">_DLiteInstance</a></div><div class="ttdef"><b>Definition:</b> dlite-entity.h:286</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
